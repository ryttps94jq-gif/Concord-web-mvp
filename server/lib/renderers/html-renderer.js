/**
 * HTML Renderer — clean HTML template wrapper for rich interactive domains.
 * Pure string concatenation, zero dependencies.
 */

/**
 * Escape HTML special characters.
 */
function esc(s) {
  return String(s || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

/**
 * Render a full HTML page from structured body content.
 *
 * @param {string} title - Page title
 * @param {string} bodyHTML - Inner HTML content (already formatted)
 * @param {Object} [opts] - Optional config
 * @param {string} [opts.theme] - "light" or "dark"
 * @returns {Buffer} HTML file buffer
 */
export function renderHTML(title, bodyHTML, opts = {}) {
  const theme = opts.theme || "light";
  const bg = theme === "dark" ? "#1a1a2e" : "#ffffff";
  const fg = theme === "dark" ? "#e0e0e0" : "#333333";
  const accent = theme === "dark" ? "#4e79a7" : "#2c5282";

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${esc(title)}</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 2rem; background: ${bg}; color: ${fg}; line-height: 1.6; }
  .container { max-width: 900px; margin: 0 auto; }
  h1 { color: ${accent}; border-bottom: 2px solid ${accent}; padding-bottom: 0.5rem; }
  h2 { color: ${accent}; margin-top: 2rem; }
  table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
  th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
  th { background: ${theme === "dark" ? "#2a2a4e" : "#f5f5f5"}; font-weight: 600; }
  tr:nth-child(even) { background: ${theme === "dark" ? "#1e1e3e" : "#fafafa"}; }
  .meta { color: #888; font-size: 0.85rem; margin-bottom: 1.5rem; }
  .section { margin-bottom: 1.5rem; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; background: ${accent}; color: white; margin-right: 4px; }
  .footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ddd; font-size: 0.8rem; color: #999; }
  ul { padding-left: 1.5rem; }
  li { margin-bottom: 0.3rem; }
</style>
</head>
<body>
<div class="container">
${bodyHTML}
<div class="footer">Generated by Concord Cognitive Engine — ${new Date().toISOString()}</div>
</div>
</body>
</html>`;

  return Buffer.from(html, "utf-8");
}

/**
 * Build a sprint retrospective HTML page.
 *
 * @param {Object} data - Retro data from artifact
 * @returns {string} Inner HTML body content
 */
export function buildRetroHTML(data) {
  const parts = [];
  parts.push(`<h1>${esc(data.title || "Sprint Retrospective")}</h1>`);
  parts.push(`<div class="meta">${esc(data.sprint || "")} — ${esc(data.date || new Date().toISOString().slice(0, 10))}</div>`);

  const categories = [
    { key: "wentWell", label: "What Went Well", emoji: "+" },
    { key: "improve", label: "What Could Improve", emoji: "-" },
    { key: "actionItems", label: "Action Items", emoji: "!" },
    { key: "kudos", label: "Kudos", emoji: "*" },
  ];

  for (const cat of categories) {
    const items = data[cat.key] || data[cat.key.toLowerCase()] || [];
    if (Array.isArray(items) && items.length) {
      parts.push(`<div class="section"><h2>${cat.emoji} ${cat.label}</h2><ul>`);
      items.forEach((item) => {
        const text = typeof item === "string" ? item : item.text || item.description || JSON.stringify(item);
        parts.push(`<li>${esc(text)}</li>`);
      });
      parts.push("</ul></div>");
    }
  }

  // Metrics table
  if (data.metrics && typeof data.metrics === "object") {
    parts.push(`<div class="section"><h2>Metrics</h2><table><tr><th>Metric</th><th>Value</th></tr>`);
    Object.entries(data.metrics).forEach(([k, v]) => {
      parts.push(`<tr><td>${esc(k)}</td><td>${esc(String(v))}</td></tr>`);
    });
    parts.push("</table></div>");
  }

  return parts.join("\n");
}

/**
 * Build a team pulse HTML report.
 *
 * @param {Object} data - Team pulse data from artifact
 * @returns {string} Inner HTML body content
 */
export function buildTeamPulseHTML(data) {
  const parts = [];
  parts.push(`<h1>${esc(data.title || "Team Pulse Report")}</h1>`);
  parts.push(`<div class="meta">Generated ${new Date().toISOString().slice(0, 10)}</div>`);

  if (data.summary) parts.push(`<div class="section"><p>${esc(data.summary)}</p></div>`);

  if (Array.isArray(data.highlights) && data.highlights.length) {
    parts.push(`<div class="section"><h2>Highlights</h2><ul>`);
    data.highlights.forEach((h) => parts.push(`<li>${esc(typeof h === "string" ? h : h.text || JSON.stringify(h))}</li>`));
    parts.push("</ul></div>");
  }

  if (Array.isArray(data.members) && data.members.length) {
    parts.push(`<div class="section"><h2>Team Members</h2><table><tr><th>Name</th><th>Role</th><th>Status</th></tr>`);
    data.members.forEach((m) => {
      parts.push(`<tr><td>${esc(m.name || "")}</td><td>${esc(m.role || "")}</td><td>${esc(m.status || "")}</td></tr>`);
    });
    parts.push("</table></div>");
  }

  return parts.join("\n");
}
